# vdso框架开发计划

## 开发目标

尽量减少vdso共享库与一般共享库的差别，减少vdso共享库的功能限制。使得可以使用接近于一般共享库的开发方式开发vdso共享库，并使其在内核态和用户态间共享。

vdso共享库在一般共享库的基础上，额外具备以下的功能：

1. 可被加载到内核态和用户态
2. 有一块不同特权级和地址空间中的vdso代码均可读写的共享数据区域，以实现通信等其它功能

目前的开发目标为以下两点：

- 对于功能1：为AsyncOS的用户态和内核态实现加载共享库机制。
- 对于功能2：为vdso的共享数据实现映射、访问和无锁同步机制。

此外，为了实现功能1，可能还需要实现一些系统功能接口在用户态和内核态的统一（例如，传统的共享库通过系统调用访问内核功能，就无法直接移植到内核）。不过目前的开发计划还未考虑这点。

## 开发计划

（以下步骤按时间顺序排列）

### 1. 私有数据相关

调研vdso共享库实现私有数据的方式：是否已经实现？（即，如果直接在vdso共享库中声明可变全局变量，能否作为私有数据正常使用？）若否，则手动实现私有数据的机制。

### 2. 共享数据相关

考虑和实现更普遍的共享数据同步方式，例如使用原子操作+让权等待。注意在实现中绕开中断/抢占机制。

当前已知，在vdso内部实现堆分配机制比较困难。因此，暂时绕过堆分配，使用静态分配的空间实现共享数据。虽然仍需考虑同步问题，但应该会简单一些？（例如环形缓冲区已知可以实现无锁MPMC（[高性能队列——Disruptor](https://tech.meituan.com/2016/11/18/disruptor.html)），我们的代码需要支持多生产者或多消费者吗？）

### 3. 与代码逻辑解耦

在内核态和用户态实现相似的、加载共享库的机制。实现根据需要，将内核的vdso库映射到用户态的机制。

### 4. 模块间依赖相关

将模块对外部的依赖尽量改为静态链接。对于无法修改的依赖，将模块与内核的通信机制改为内核修改模块的数据；将模块间的通信机制改为类似RPC。

### 5. vdso共享库实例

将内核的一个模块（如文件系统或网络）改造成vdso共享库，并验证其可以在内核态、在用户态被加载、被使用。

由于第4项的改造可能缺乏实例，考虑将第4步和第5步穿插进行。
